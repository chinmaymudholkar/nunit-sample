name: .NET Test Suite

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    # Run every Monday at 2:00 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch: # Allow manual triggering

jobs:

  test:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Install the .NET Core workload
    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # Restore and build to get Playwright tooling
    - name: Restore and build
      run: dotnet build

    # Install Playwright browsers
    - name: Install Playwright dependencies
      run: |
        # Find the playwright.ps1 script in the build output directory
        # It could be in net8.0, net10.0 (if project incorrectly targets it), or other locations
        $possiblePaths = @(
          "bin\Debug\net8.0\playwright.ps1",
          "bin\Debug\net10.0\playwright.ps1",
          "bin\Release\net8.0\playwright.ps1",
          "bin\Release\net10.0\playwright.ps1"
        )
        
        $playwrightScript = $null
        foreach ($path in $possiblePaths) {
          if (Test-Path $path) {
            $playwrightScript = $path
            Write-Host "Found Playwright script at: $playwrightScript"
            break
          }
        }
        
        if (-not $playwrightScript) {
          Write-Host "Playwright script not found in expected locations, searching recursively..."
          $foundScript = Get-ChildItem -Path . -Filter "playwright.ps1" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($foundScript) {
            $playwrightScript = $foundScript.FullName
            Write-Host "Found Playwright script at: $playwrightScript"
          }
        }
        
        if ($playwrightScript) {
          Write-Host "Installing Playwright browsers using script: $playwrightScript"
          pwsh $playwrightScript install --with-deps
        } else {
          Write-Host "Warning: Could not find playwright.ps1 script. Browsers may not be installed."
        }

    # Execute all tests in the solution
    - name: Execute tests
      run: dotnet test --logger "trx;LogFileName=test-results.trx" --results-directory "TestResults"
      env:
        # Variables from GitHub repository variables
        BASE_URL: ${{ vars.BASE_URL }}
        SWAG_LABS_USERNAME: ${{ vars.SWAG_LABS_USERNAME }}
        BROWSER: ${{ vars.BROWSER }}
        HEADLESS: ${{ vars.HEADLESS }}
        SLOW_MO: ${{ vars.SLOW_MO }}
        # Secret from GitHub secrets (password)
        SWAG_LABS_PASSWORD: ${{ secrets.SWAG_LABS_PASSWORD }}

    # Install Allure commandline
    - name: Install Allure CLI
      run: |
        $allureVersion = "2.24.1"
        $allureUrl = "https://github.com/allure-framework/allure2/releases/download/$allureVersion/allure-$allureVersion.zip"
        $allureZip = "$env:TEMP\allure.zip"
        $allureDir = "$env:TEMP\allure"
        Invoke-WebRequest -Uri $allureUrl -OutFile $allureZip
        Expand-Archive -Path $allureZip -DestinationPath $allureDir -Force
        $allureBin = Get-ChildItem -Path $allureDir -Filter "allure.bat" -Recurse | Select-Object -First 1
        if ($allureBin) {
          $env:PATH = "$($allureBin.DirectoryName);$env:PATH"
          echo "$($allureBin.DirectoryName)" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
        }

    # Generate Allure report
    - name: Generate Allure report
      run: |
        # Find Allure CLI
        $allureDir = "$env:TEMP\allure"
        $allureBin = Get-ChildItem -Path $allureDir -Filter "allure.bat" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $allureBin) {
          Write-Host "Allure CLI not found, attempting to use from PATH"
          $allureCmd = "allure"
        } else {
          $allureCmd = $allureBin.FullName
          Write-Host "Using Allure CLI from: $allureCmd"
        }
        
        # Search for allure-results in common locations
        $possiblePaths = @(
          "bin\Debug\net8.0\allure-results",
          "bin\Debug\net10.0\allure-results",
          "bin\Release\net8.0\allure-results",
          "bin\Release\net10.0\allure-results",
          "TestResults\allure-results",
          "allure-results"
        )
        
        $allureResultsPath = $null
        foreach ($path in $possiblePaths) {
          if (Test-Path $path) {
            $allureResultsPath = $path
            Write-Host "Found Allure results at: $allureResultsPath"
            break
          }
        }
        
        if ($allureResultsPath) {
          # Generate Allure report
          Write-Host "Generating Allure report from $allureResultsPath"
          & $allureCmd generate $allureResultsPath --clean -o allure-report
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Allure report generation failed with exit code: $LASTEXITCODE"
            exit 1
          }
          Write-Host "Allure report generated successfully"
        } else {
          Write-Host "No Allure results found in any of the expected locations"
          Write-Host "Searched paths: $($possiblePaths -join ', ')"
          Write-Host "Skipping Allure report generation - no results to publish"
          # Create empty directory so the upload step doesn't fail
          New-Item -ItemType Directory -Force -Path allure-report | Out-Null
        }

    # Upload Allure report as artifact
    - name: Upload Allure report
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: allure-report
        retention-days: 30

  deploy:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # Download Allure report artifact
    - name: Download Allure report
      uses: actions/download-artifact@v4
      with:
        name: allure-report
        path: allure-report

    # Deploy to GitHub Pages
    - name: Setup Pages
      uses: actions/configure-pages@v5

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: allure-report

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    # Output GitHub Pages URL
    - name: Display GitHub Pages URL
      run: |
        PAGES_URL="${{ steps.deployment.outputs.page_url }}"
        if [ -z "$PAGES_URL" ]; then
          REPO="${{ github.repository }}"
          REPO_OWNER="${REPO%%/*}"
          REPO_NAME="${REPO#*/}"
          PAGES_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}/"
        fi
        {
          echo "## Allure Report Published"
          echo ""
          echo "**View your Allure test report at:**"
          echo "[${PAGES_URL}](${PAGES_URL})"
          echo ""
          echo "The report will be available in a few minutes."
          echo ""
          echo "**Direct link:** ${PAGES_URL}"
        } >> $GITHUB_STEP_SUMMARY
